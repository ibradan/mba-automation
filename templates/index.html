<!doctype html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MBA7 Automation</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>

<body>
  <div class="container">
    <!-- ================= HEADER ================= -->
    <header class="site-head">
      <div class="brand-left">
        <div class="logo">MA</div>
        <div>
          <h1 class="app-title">MBA7 Automation</h1>
          <p class="lead">Akun akan dijalankan otomatis sesuai jadwal. Atur nomor & level di sini.</p>
        </div>
      </div>
      <a href="/logs" class="btn btn-ghost" title="View Logs" style="font-size: 1.2rem; padding: 8px 12px;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="4 17 10 11 4 5"></polyline>
          <line x1="12" y1="19" x2="20" y2="19"></line>
        </svg>
      </a>
    </header>

    <!-- ================= FLASH MESSAGE ================= -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, msg in messages %}
    <div class="flash {{ category }}">{{ msg }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- ================= MAIN FORM ================= -->
    <form method="post" id="automation-form">
      <!-- Marker untuk test / selector JS -->
      <span hidden class="review-btn"></span>
      <span hidden class="schedule-btn"></span>

      <!-- ===== ROWS WRAPPER ===== -->
      <div id="rows">
        {%- if saved and saved|length > 0 %}
        {%- for acc in saved %}
        <div class="account-card row-item {{ acc.status }}">

          <div class="inputs">
            <!-- Phone -->
            <div class="phone-group">
              <span class="phone-prefix">+62</span>
              <input name="phone[]" type="text" placeholder="NO HP" value="{{ acc.phone_display }}" maxlength="13"
                required />
            </div>

            <!-- Password -->
            <div class="pwd-field">
              <input name="password[]" class="pwd" type="password" placeholder="PASSWORD" value="{{ acc.password }}"
                required />
              <button type="button" class="pwd-toggle" aria-label="Toggle password" title="Tampilkan Password">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="eye-icon">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" />
                  <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="eye-off-icon" style="display:none;">
                  <path
                    d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  <line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
              </button>
            </div>

            <!-- Level -->
            <select name="level[]" aria-label="Level">
              <option value="E1" {{ 'selected' if acc.level=='E1' else '' }}>E1</option>
              <option value="E2" {{ 'selected' if acc.level=='E2' else '' }}>E2</option>
              <option value="E3" {{ 'selected' if acc.level=='E3' else '' }}>E3</option>
            </select>

            <!-- Action buttons -->
            <div class="action-group">
              <!-- Play Button (Run Single) -->
              <button type="button" class="btn btn-success play-btn" title="Jalankan Akun Ini" data-bound="1">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="play-icon">
                  <polygon points="5 3 19 12 5 21 5 3" stroke="currentColor" stroke-width="2" fill="currentColor"
                    stroke-linejoin="round" />
                </svg>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="spinner-icon" style="display:none;">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" opacity="0.25" />
                  <path d="M12 2 A10 10 0 0 1 22 12" stroke="currentColor" stroke-width="2" fill="none"
                    stroke-linecap="round">
                    <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s"
                      repeatCount="indefinite" />
                  </path>
                </svg>
              </button>

              <button type="button" class="btn btn-primary review-btn" title="Set Review Harian">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M21 15v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4" stroke="currentColor" stroke-width="1.6"
                    stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M7 10l5-5 5 5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
                <span>Review</span>
              </button>

              <button type="button" class="btn btn-secondary schedule-btn" title="Set Jadwal">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.6" />
                  <path d="M12 7v6l4 2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
                <span>Jadwal</span>
              </button>

              <button type="button" class="btn btn-danger reset-btn" title="Reset last_run">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M20 12a8 8 0 1 0-2.5 5.7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                    stroke-linejoin="round" />
                  <path d="M20 7v5h-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
                <span>Reset</span>
              </button>
            </div>
          </div>

          <!-- Tombol hapus akun -->
          <button type="button" class="remove" onclick="removeRow(this)" title="Hapus akun" aria-label="Hapus akun">
            <span aria-hidden="true">−</span>
          </button>
        </div>
        {%- endfor %}
        {%- else %}
        <!-- ========== BARIS DEFAULT 1 (wajib isi, required) ========== -->
        <div class="account-card row-item">
          <div class="inputs">
            <div class="phone-group">
              <span class="phone-prefix">+62</span>
              <input name="phone[]" type="text" placeholder="NO HP" required />
            </div>

            <div class="pwd-field">
              <input name="password[]" class="pwd" type="password" placeholder="PASSWORD" required />
              <button type="button" class="pwd-toggle" aria-label="Toggle password">
                Tampilkan
              </button>
            </div>

            <select name="level[]" aria-label="Level">
              <option value="E1">E1</option>
              <option value="E2" selected>E2</option>
              <option value="E3">E3</option>
            </select>

            <div class="action-group">
              <button type="button" class="btn btn-primary review-btn" title="Set Review Harian">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M21 15v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4" stroke="currentColor" stroke-width="1.6"
                    stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M7 10l5-5 5 5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
                <span>Review</span>
              </button>

              <button type="button" class="btn btn-secondary schedule-btn" title="Set Jadwal">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.6" />
                  <path d="M12 7v6l4 2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
                <span>Jadwal</span>
              </button>

              <button type="button" class="btn btn-danger reset-btn" title="Reset last_run">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M20 12a8 8 0 1 0-2.5 5.7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                    stroke-linejoin="round" />
                  <path d="M20 7v5h-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
                <span>Reset</span>
              </button>
            </div>
          </div>

          <button type="button" class="remove" onclick="removeRow(this)" title="Hapus akun" aria-label="Hapus akun">
            <span aria-hidden="true">−</span>
          </button>
        </div>

        <!-- ========== BARIS DEFAULT 2 (opsional, tidak required) ========== -->
        <div class="account-card row-item">
          <div class="inputs">
            <div class="phone-group">
              <span class="phone-prefix">+62</span>
              <input name="phone[]" type="text" placeholder="NO HP" maxlength="13" />
            </div>

            <div class="pwd-field">
              <input name="password[]" class="pwd" type="password" placeholder="PASSWORD" />
              <button type="button" class="pwd-toggle" aria-label="Toggle password" title="Tampilkan Password">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="eye-icon">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" />
                  <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="eye-off-icon" style="display:none;">
                  <path
                    d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  <line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
              </button>
            </div>

            <select name="level[]" aria-label="Level">
              <option value="E1">E1</option>
              <option value="E2" selected>E2</option>
              <option value="E3">E3</option>
            </select>

            <div class="action-group">
              <button type="button" class="btn btn-success play-btn" title="Jalankan Akun Ini">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="play-icon">
                  <polygon points="5 3 19 12 5 21 5 3" stroke="currentColor" stroke-width="2" fill="currentColor"
                    stroke-linejoin="round" />
                </svg>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="spinner-icon" style="display:none;">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" opacity="0.25" />
                  <path d="M12 2 A10 10 0 0 1 22 12" stroke="currentColor" stroke-width="2" fill="none"
                    stroke-linecap="round">
                    <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s"
                      repeatCount="indefinite" />
                  </path>
                </svg>
              </button>
              <button type="button" class="btn btn-primary review-btn" title="Set Review Harian">
                Review
              </button>
              <button type="button" class="btn btn-secondary schedule-btn" title="Set Jadwal">
                Jadwal
              </button>
              <button type="button" class="btn btn-danger reset-btn" title="Reset last_run">
                Reset
              </button>
            </div>
          </div>

          <button type="button" class="remove" onclick="removeRow(this)" title="Hapus akun" aria-label="Hapus akun">
            <span aria-hidden="true">−</span>
          </button>
        </div>
        {%- endif %}
      </div>

      <!-- ===== CONTROLS (Add & Save) ===== -->
      <!-- ===== BOTTOM ACTIONS ===== -->
      <div class="bottom-controls">
        <!-- Headless Toggle -->
        <label class="headless-label">
          <input type="checkbox" id="headless-checkbox" {{ 'checked' if headless_default else '' }} />
          <input type="hidden" name="headless" id="headless-input"
            value="{{ 'true' if headless_default else 'false' }}" />
          Jalankan headless
        </label>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button type="button" id="add-row" title="Tambah Nomor" aria-label="Tambah Nomor">
            <span class="add-icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true" focusable="false">
                <rect x="0" y="0" width="24" height="24" rx="12" fill="none" />
                <path d="M12 6v12M6 12h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
            </span>
            <span class="add-text">Tambah Nomor</span>
          </button>

          <button type="submit" name="action" value="save" class="btn btn-ghost">
            Simpan Pengaturan
          </button>

          <button type="submit" name="action" value="start" class="btn btn-primary" id="run-all-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="play-icon">
              <polygon points="5 3 19 12 5 21 5 3" stroke="currentColor" stroke-width="1.6" fill="currentColor" />
            </svg>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="spinner-icon" style="display:none;">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" opacity="0.25" />
              <path d="M12 2 A10 10 0 0 1 22 12" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round">
                <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s"
                  repeatCount="indefinite" />
              </path>
            </svg>
            <span id="btn-text">Jalankan Semua</span>
          </button>
        </div>
      </div>

      <p class="actions-note small-muted">
        Automation tetap berjalan otomatis sesuai jadwal tiap akun.
        Tombol <strong>“Jalankan Semua”</strong> hanya untuk
        menjalankan semua akun sekaligus saat ini.
      </p>
    </form>

    <!-- STATUS LEGEND -->
    <p class="mt-8 small-muted">
      Status warna: <strong>hijau</strong> = selesai,
      <strong>kuning</strong> = terlewat,
      <strong>abu</strong> = belum jalan.
    </p>
  </div>

  <!-- ================= SCRIPTS ================= -->
  <script>
    function removeRow(btn) {
      const row = btn.closest('.row-item');
      if (!row) return;

      const rows = document.querySelectorAll('.row-item');
      // minimal 1 row harus tersisa
      if (rows.length <= 1) {
        alert('Minimal satu akun harus ada!');
        return;
      }

      // Cek apakah akun sudah tersimpan (punya data phone)
      const phoneInput = row.querySelector('input[name="phone[]"]');
      const phone = phoneInput ? phoneInput.value.trim() : '';

      if (phone) {
        // Akun sudah ada phonenya, minta konfirmasi
        if (!confirm('Hapus akun +62' + phone + '?\n\nAkun ini sudah tersimpan. Yakin ingin menghapus?')) {
          return;
        }
      }

      row.remove();
    }

    // Loading state for run-all button
    document.getElementById('automation-form').addEventListener('submit', function (e) {
      const btn = document.getElementById('run-all-btn');
      if (e.submitter && e.submitter.name === 'action' && e.submitter.value === 'start') {
        btn.disabled = true;
        btn.querySelector('.play-icon').style.display = 'none';
        btn.querySelector('.spinner-icon').style.display = 'inline';
        document.getElementById('btn-text').textContent = 'Menjalankan...';
      }
    });

    document
      .getElementById('add-row')
      .addEventListener('click', function () {
        const rows = document.getElementById('rows');
        const div = document.createElement('div');
        div.className = 'account-card row-item';

        // template baris baru = sama seperti baris default pertama (required)
        div.innerHTML = `
            <div class="inputs">
              <div class="phone-group">
                <span class="phone-prefix">+62</span>
                <input
                  name="phone[]"
                  type="text"
                  placeholder="NO HP"
                  maxlength="13"
                  required
                />
              </div>

              <div class="pwd-field">
                <input
                  name="password[]"
                  class="pwd"
                  type="password"
                  placeholder="PASSWORD"
                  required
                />
                <button
                  type="button"
                  class="pwd-toggle"
                  aria-label="Toggle password"
                  title="Tampilkan Password"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="eye-icon">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="eye-off-icon" style="display:none;">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>

              <select name="level[]" aria-label="Level">
                <option value="E1">E1</option>
                <option value="E2" selected>E2</option>
                <option value="E3">E3</option>
              </select>

              <div class="action-group">
                <button type="button" class="btn btn-success play-btn" title="Jalankan Akun Ini">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="play-icon">
                    <polygon points="5 3 19 12 5 21 5 3" stroke="currentColor" stroke-width="2" fill="currentColor" stroke-linejoin="round"/>
                  </svg>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="spinner-icon" style="display:none;">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" opacity="0.25"/>
                    <path d="M12 2 A10 10 0 0 1 22 12" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round">
                      <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/>
                    </path>
                  </svg>
                </button>

                <button
                  type="button"
                  class="btn btn-primary review-btn"
                  title="Set Review Harian"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    aria-hidden="true"
                  >
                    <path
                      d="M21 15v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4"
                      stroke="currentColor"
                      stroke-width="1.6"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M7 10l5-5 5 5"
                      stroke="currentColor"
                      stroke-width="1.6"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                  <span>Review</span>
                </button>

                <button
                  type="button"
                  class="btn btn-secondary schedule-btn"
                  title="Set Jadwal"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    aria-hidden="true"
                  >
                    <circle
                      cx="12"
                      cy="12"
                      r="9"
                      stroke="currentColor"
                      stroke-width="1.6"
                    />
                    <path
                      d="M12 7v6l4 2"
                      stroke="currentColor"
                      stroke-width="1.6"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                  <span>Jadwal</span>
                </button>

                <button
                  type="button"
                  class="btn btn-danger reset-btn"
                  title="Reset last_run"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    aria-hidden="true"
                  >
                    <path
                      d="M20 12a8 8 0 1 0-2.5 5.7"
                      stroke="currentColor"
                      stroke-width="1.6"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M20 7v5h-5"
                      stroke="currentColor"
                      stroke-width="1.6"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                  <span>Reset</span>
                </button>
              </div>
            </div>

            <button
              type="button"
              class="remove"
              onclick="removeRow(this)"
              title="Hapus akun"
              aria-label="Hapus akun"
            >
              <span aria-hidden="true">−</span>
            </button>
        `;

        rows.appendChild(div);

        attachToggle(div);
        attachReviewButtons();
        attachScheduleButtons();
        attachResetButtons();
        attachPlayButtons(); // Attach play button listener
      });

    // ================= PASSWORD TOGGLE =================
    function attachToggle(root) {
      const btn = root.querySelector('.pwd-toggle');
      if (!btn || btn.dataset.bound) return;

      btn.dataset.bound = '1';
      btn.addEventListener('click', function () {
        const input = root.querySelector('.pwd');
        if (!input) return;

        const eyeIcon = btn.querySelector('.eye-icon');
        const eyeOffIcon = btn.querySelector('.eye-off-icon');

        if (input.type === 'password') {
          input.type = 'text';
          btn.title = 'Sembunyikan Password';
          if (eyeIcon) eyeIcon.style.display = 'none';
          if (eyeOffIcon) eyeOffIcon.style.display = 'block';
        } else {
          input.type = 'password';
          btn.title = 'Tampilkan Password';
          if (eyeIcon) eyeIcon.style.display = 'block';
          if (eyeOffIcon) eyeOffIcon.style.display = 'none';
        }
      });
    }

    document
      .querySelectorAll('.row-item')
      .forEach(function (row) { attachToggle(row); });

    // ================= PLAY BUTTON (RUN SINGLE) =================
    function attachPlayButtons() {
      document.querySelectorAll('.play-btn').forEach(function (btn) {
        if (btn.dataset.bound) return;
        btn.dataset.bound = '1';

        btn.addEventListener('click', async function () {
          const row = btn.closest('.row-item');
          if (!row) return;

          const phoneInput = row.querySelector('input[name="phone[]"]');
          if (!phoneInput) return;

          const phone = phoneInput.value.trim();
          if (!phone) {
            alert('Masukkan nomor HP terlebih dahulu.');
            return;
          }

          // Show loading state
          const originalIcon = btn.querySelector('.play-icon');
          const spinnerIcon = btn.querySelector('.spinner-icon');

          btn.disabled = true;
          originalIcon.style.display = 'none';
          spinnerIcon.style.display = 'inline';

          try {
            const formData = new FormData();
            formData.append('phone', phone);

            const res = await fetch('/run_single', {
              method: 'POST',
              body: formData
            });
            const data = await res.json();

            if (data.ok) {
              // Show toast or simple alert for now
              // alert('Automation started for +62' + phone);
              // Redirect to logs or just stay? Let's stay but maybe show a flash message
              // For now, just reload to update status or show success
              window.location.reload();
            } else {
              alert('Error: ' + data.msg);
              // Reset state
              btn.disabled = false;
              originalIcon.style.display = 'inline';
              spinnerIcon.style.display = 'none';
            }
          } catch (err) {
            alert('Gagal menghubungi server.');
            console.error(err);
            // Reset state
            btn.disabled = false;
            originalIcon.style.display = 'inline';
            spinnerIcon.style.display = 'none';
          }
        });
      });
    }
    attachPlayButtons();

    // ================= REVIEW BUTTON =================
    function attachReviewButtons() {
      document.querySelectorAll('.review-btn').forEach(function (btn) {
        if (btn.dataset.bound) return;
        btn.dataset.bound = '1';

        btn.addEventListener('click', function () {
          const row = btn.closest('.row-item');
          if (!row) return;

          const phoneInput = row.querySelector('input[name="phone[]"]');
          if (!phoneInput) return;

          const phone = phoneInput.value.trim();
          if (!phone) {
            alert('Masukkan nomor HP terlebih dahulu.');
            return;
          }

          window.location = '/review?phone=' + encodeURIComponent(phone);
        });
      });
    }
    attachReviewButtons();

    // ================= SCHEDULE BUTTON =================
    function attachScheduleButtons() {
      document.querySelectorAll('.schedule-btn').forEach(function (btn) {
        if (btn.dataset.bound) return;
        btn.dataset.bound = '1';

        btn.addEventListener('click', function () {
          const row = btn.closest('.row-item');
          if (!row) return;

          const phoneInput = row.querySelector('input[name="phone[]"]');
          if (!phoneInput) return;

          const phone = phoneInput.value.trim();
          if (!phone) {
            alert('Masukkan nomor HP terlebih dahulu.');
            return;
          }

          window.location = '/schedule?phone=' + encodeURIComponent(phone);
        });
      });
    }
    attachScheduleButtons();

    // ================= RESET BUTTON =================
    function attachResetButtons() {
      document.querySelectorAll('.reset-btn').forEach(function (btn) {
        if (btn.dataset.bound) return;
        btn.dataset.bound = '1';

        btn.addEventListener('click', async function () {
          const row = btn.closest('.row-item');
          if (!row) return;

          const phoneInput = row.querySelector('input[name="phone[]"]');
          if (!phoneInput) return;

          const phone = phoneInput.value.trim();
          if (!phone) {
            alert('Masukkan nomor HP terlebih dahulu.');
            return;
          }

          if (!confirm('Hapus catatan last_run untuk ' + phone + '?')) return;

          try {
            const form = new FormData();
            form.append('phone', phone);

            const res = await fetch('/reset_last_run', {
              method: 'POST',
              body: form
            });

            const data = await res.json();

            if (res.ok && data.ok) {
              alert('last_run dihapus untuk ' + phone);
              window.location.reload();
            } else {
              alert('Gagal: ' + (data.msg || res.statusText));
            }
          } catch (err) {
            alert('Error saat menghubungi server: ' + err);
          }
        });
      });
    }
    attachResetButtons();

    // ================= HEADLESS SYNC =================
    const headlessCheckbox = document.getElementById('headless-checkbox');
    const headlessInput = document.getElementById('headless-input');

    if (headlessCheckbox && headlessInput) {
      headlessCheckbox.addEventListener('change', function () {
        headlessInput.value = headlessCheckbox.checked ? 'true' : 'false';
      });

      document
        .getElementById('automation-form')
        .addEventListener('submit', function () {
          headlessInput.value = headlessCheckbox.checked ? 'true' : 'false';
        });
    }

    // ================= ADD-ROW MICRO INTERACTION =================
    const addRowBtn = document.getElementById('add-row');
    if (addRowBtn) {
      addRowBtn.addEventListener('click', function () {
        addRowBtn.classList.add('clicked');
        setTimeout(() => addRowBtn.classList.remove('clicked'), 240);
      });
    }
  </script>
</body>

</html>