<!doctype html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="theme-color" content="#1e293b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=24" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Staggered entry for cards */
    .account-card:nth-child(1) {
      animation-delay: 0.1s;
    }

    .account-card:nth-child(2) {
      animation-delay: 0.15s;
    }

    .account-card:nth-child(3) {
      animation-delay: 0.2s;
    }

    .account-card:nth-child(4) {
      animation-delay: 0.25s;
    }

    .account-card:nth-child(n+5) {
      animation-delay: 0.3s;
    }

    /* Chart Styles */
    .chart-wrapper {
      margin-top: 1rem;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #e2e8f0;
      height: 320px;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }

    .chart-wrapper canvas {
      width: 100% !important;
      max-height: 240px !important;
    }

    .chart-nav-btn {
      background: #ffffff;
      border: 1px solid #cbd5e1;
      color: #64748b;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chart-nav-btn:hover:not(:disabled) {
      background: #f1f5f9;
      color: #334155;
      border-color: #94a3b8;
    }

    .chart-nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .toggle-chart-btn {
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      transition: all 0.2s;
      padding: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      /* Push to right if in flex */
    }

    .toggle-chart-btn:hover {
      color: #f8fafc;
      background: rgba(255, 255, 255, 0.1);
    }

    .toggle-chart-btn.active svg {
      transform: rotate(180deg);
    }

    /* New UI Elements */
    .system-status {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-left: 12px;
      padding-left: 12px;
      border-left: 1px solid rgba(255, 255, 255, 0.12);
    }

    .queue-badge {
      background: rgba(30, 41, 59, 0.6);
      color: #94a3b8;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.5px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .queue-badge .dot {
      width: 6px;
      height: 6px;
      background: #94a3b8;
      border-radius: 50%;
    }

    .queue-badge.active {
      color: #38bdf8;
      border-color: rgba(56, 189, 248, 0.2);
    }

    .queue-badge.active .dot {
      background: #38bdf8;
      box-shadow: 0 0 8px #38bdf8;
      animation: pulse 2s infinite;
    }

    .save-status {
      font-size: 11px;
      color: #94a3b8;
      margin-left: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: opacity 0.3s;
    }

    @keyframes pulse {
      0% {
        opacity: 0.4;
      }

      50% {
        opacity: 1;
      }

      100% {
        opacity: 0.4;
      }
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div id="toast-container"></div>
  <div class="container">
    <header class="glass-header">
      <div class="header-content">
        <div class="brand-left">
          <h1 class="main-title">TERNAK <span>UANG</span></h1>
          <div class="brand-meta">
            <p class="subtitle">Automasi Cuan Maksimal üí∞</p>
            <div id="queue-status" class="queue-badge" title="Jumlah antrean tugas saat ini">
              <span class="dot"></span> Queue: <span id="queue-count">0</span>
            </div>
          </div>
        </div>
        <div class="settings-dropdown">
          <button type="button" class="btn-icon" id="settings-toggle" title="Pengaturan" aria-label="Pengaturan">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
              <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z" />
            </svg>
          </button>
          <div class="settings-menu" id="settings-menu" style="display: none;">
            <div class="settings-header">Settings</div>



            <!-- Auto Reconnect WiFi -->
            <label class="settings-item">
              <div class="toggle-switch">
                <input type="checkbox" id="setting-wifi" {% if settings.get('auto_reconnect_wifi') %}checked{% endif
                  %} />
                <span class="slider"></span>
              </div>
              <span>Auto reconnect WiFi</span>
            </label>

            <!-- Timeout -->
            <div class="settings-item">
              <span>Timeout</span>
              <select id="setting-timeout" class="settings-select">
                <option value="15" {% if settings.get('timeout')|int==15 %}selected{% endif %}>15s</option>
                <option value="30" {% if settings.get('timeout')|default(30)|int==30 %}selected{% endif %}>30s</option>
                <option value="60" {% if settings.get('timeout')|int==60 %}selected{% endif %}>60s</option>
              </select>
            </div>

            <!-- Viewport -->
            <div class="settings-item">
              <span>Viewport</span>
              <select id="setting-viewport" class="settings-select">
                <option value="iPhone 12" {% if settings.get('viewport')=='iPhone 12' %}selected{% endif %}>iPhone 12
                </option>
                <option value="Pixel 5" {% if settings.get('viewport')=='Pixel 5' %}selected{% endif %}>Pixel 5</option>
                <option value="Samsung S21" {% if settings.get('viewport')=='Samsung S21' %}selected{% endif %}>Samsung
                  S21</option>
              </select>
            </div>

            <!-- Log Level -->
            <div class="settings-item">
              <span>Log Level</span>
              <select id="setting-loglevel" class="settings-select">
                <option value="INFO" {% if settings.get('log_level')=='INFO' %}selected{% endif %}>INFO</option>
                <option value="DEBUG" {% if settings.get('log_level')=='DEBUG' %}selected{% endif %}>DEBUG</option>
              </select>
            </div>

            <hr class="settings-divider">
            <div class="settings-header" style="font-size: 11px; opacity: 0.7; margin-bottom: 8px;">Telegram
              Notification</div>

            <div class="settings-item-vertical">
              <span>Bot Token</span>
              <input type="password" id="setting-telegram-token" class="settings-input" placeholder="123456:ABC..."
                value="{{ settings.get('telegram_token', '') }}">
            </div>

            <div class="settings-item-vertical">
              <span>Chat ID</span>
              <input type="text" id="setting-telegram-chat-id" class="settings-input" placeholder="987654321"
                value="{{ settings.get('telegram_chat_id', '') }}">
            </div>

            <div style="padding: 0 12px 10px;">
              <button type="button" id="btn-test-telegram" class="btn-small"
                style="width: 100%; justify-content: center; background: #0088cc; color: white; border: none;">
                Tes Telegram ‚úàÔ∏è
              </button>
            </div>

            <hr class="settings-divider">

            <!-- Export/Import -->
            <div class="settings-actions">
              <button type="button" id="btn-export" class="btn-small">Export JSON</button>
              <button type="button" id="btn-import-trigger" class="btn-small">Import JSON</button>
              <input type="file" id="file-import" style="display: none" accept=".json" />
            </div>

            <hr class="settings-divider">

            <div style="padding: 0 12px 12px; display: flex; flex-direction: column; gap: 8px;">
            </div>

            <hr class="settings-divider">


            <hr class="settings-divider">

            <a href="/logs" class="settings-link">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              Lihat Log
            </a>
          </div>
        </div>
    </header>

    <!-- ================= FLASH MESSAGE ================= -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, msg in messages %}
    <div class="flash {{ category }}">{{ msg }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- ================= MAIN FORM ================= -->
    <form method="post" id="automation-form">

      <!-- ===== ROWS WRAPPER ===== -->
      <div id="rows">
        {%- if saved and saved|length > 0 %}
        {%- for acc in saved %}
        {% set status_class = acc.status if acc.status else 'pending' %}

        <div class="account-card row-item {{ status_class }}" data-history='{{ acc.daily_progress | tojson | safe }}'
          data-phone="{{ acc.phone_display }}" data-last-sync="{{ acc.last_sync_ts[:10] if acc.last_sync_ts else '' }}"
          data-last-sync-ts="{{ acc.last_sync_ts if acc.last_sync_ts else '' }}">
          <div class="inputs">

            {# Daily Progress Indicator (provided by backend) #}
            {% set stats = acc.display_stats %}
            {% set completed = stats.get('completed', 0) %}
            {% set target = stats.get('total', 60) %}
            {% set pct = stats.get('percentage', 0) %}
            {% set label = acc.today_label %}

            {% if acc.status == 'ran' %}
            {% set progress_class = 'progress-complete' %}
            {% elif acc.status == 'due' %}
            {% set progress_class = 'progress-partial' %}
            {% else %}
            {% set progress_class = 'progress-low' %}
            {% endif %}

            {# Progress Bar + Delete Button Row (AT THE TOP) #}
            <div class="progress-delete-row">
              <div class="account-number">{{ loop.index }}</div>
              <div class="daily-progress {{ progress_class }}">
                <div class="progress-fill" data-pct="{{ pct }}">
                  <div class="liquid"></div>
                </div>
                <div class="progress-text-overlay">
                  <span class="progress-label">{{ label }}</span>
                  <span class="progress-value">{{ completed }}/{{ target }}</span>
                </div>
              </div>
              <button type="button" class="remove" onclick="removeRow(this)" title="Hapus akun" aria-label="Hapus akun">
                <span aria-hidden="true">‚àí</span>
              </button>
            </div>

            <div class="main-inputs">
              {# Row 1: Phone | Password #}
              <div class="input-row row-1">
                <div class="phone-group">
                  <span class="phone-prefix">+62</span>
                  <input name="phone[]" type="text" placeholder="NO HP" value="{{ acc.phone_display }}" maxlength="13"
                    required />
                </div>
                <div class="pwd-field">
                  <input name="password[]" class="pwd" type="password" placeholder="Kata Sandi"
                    value="{{ acc.password }}" maxlength="15" required autocomplete="new-password" />
                  <button type="button" class="pwd-toggle" aria-label="Toggle password" title="Tampilkan Password">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round" class="eye-icon" style="opacity: 0.6;">
                      <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                      <circle cx="12" cy="12" r="3" />
                    </svg>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round" class="eye-off-icon"
                      style="display:none; opacity: 0.6;">
                      <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" />
                      <path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" />
                      <path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61" />
                      <line x1="2" x2="22" y1="2" y2="22" />
                    </svg>
                  </button>
                </div>

                <div class="more-actions-wrapper">
                  <button type="button" class="btn-icon more-btn" title="Lainnya">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                      stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="1" />
                      <circle cx="12" cy="5" r="1" />
                      <circle cx="12" cy="19" r="1" />
                    </svg>
                  </button>
                  <div class="more-dropdown">
                    <button type="button" class="btn btn-ghost play-btn" title="Jalankan Akun">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        class="play-icon">
                        <polygon points="5 3 19 12 5 21 5 3" fill="currentColor" />
                      </svg>
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="spinner-icon"
                        style="display:none;">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"
                          opacity="0.25" />
                        <path d="M12 2 A10 10 0 0 1 22 12" stroke="currentColor" stroke-width="2" fill="none"
                          stroke-linecap="round">
                          <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12"
                            dur="1s" repeatCount="indefinite" />
                        </path>
                      </svg>
                      <span>Run</span>
                    </button>

                    {% set synced_today = False %}
                    {% if acc.last_sync_ts %}
                    {% set sync_dt = acc.last_sync_ts[:10] %}
                    {% if sync_dt == now.strftime('%Y-%m-%d') %}
                    {% set synced_today = True %}
                    {% endif %}
                    {% endif %}
                    {% set is_loading = acc.is_syncing %}

                    <button type="button" class="btn btn-ghost sync-btn" title="Sync Saldo" {% if is_loading
                      %}disabled{% endif %}>
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        class="sync-icon">
                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2" />
                      </svg>
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="spinner-icon"
                        style="display:none;">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"
                          opacity="0.25" />
                        <path d="M12 2 A10 10 0 0 1 22 12" stroke="currentColor" stroke-width="2" fill="none"
                          stroke-linecap="round">
                          <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12"
                            dur="1s" repeatCount="indefinite" />
                        </path>
                      </svg>
                      <span>Sync</span>
                    </button>
                  </div>
                </div>
              </div>

              {# Row 2: Level | Review | Schedule #}
              <div class="input-row row-2">
                <select name="level[]" aria-label="Level" class="level-select">
                  <option value="E1" {% if acc.level=='E1' %}selected{% endif %}>E1</option>
                  <option value="E2" {% if acc.level=='E2' %}selected{% endif %}>E2</option>
                  <option value="E3" {% if acc.level=='E3' %}selected{% endif %}>E3</option>
                </select>

                <button type="button" class="btn btn-primary review-btn" title="Set Review Harian">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M21 15v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4" stroke="currentColor" stroke-width="1.6"
                      stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M7 10l5-5 5 5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                      stroke-linejoin="round" />
                  </svg>
                  <span>Review</span>
                </button>

                <button type="button" class="btn btn-secondary schedule-btn" title="Set Jadwal">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.6" />
                    <path d="M12 7v6l4 2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                      stroke-linejoin="round" />
                  </svg>
                  <span>{% if acc.schedule %}{{ acc.schedule }}{% else %}Jadwal{% endif %}</span>
                </button>
              </div>

              {# Row 3: Status Info #}
              <div class="input-row row-3">
                <div class="schedule-status" style="width: 100%; text-align: center;">
                  {% if acc.schedule %}
                  Otomatis jam {{ acc.schedule }}
                  {% else %}
                  Belum ada jadwal
                  {% endif %}
                </div>
              </div>
            </div>

            {# Stats Row (Modal & Pendapatan) - AT THE BOTTOM #}
            {% if acc.display_stats %}
            <div class="stats-row" style="position: relative;">
              {% set income = acc.display_stats.get('income', 0) %}
              {% if acc.phone_display %}
              <a href="{{ url_for('history', phone=acc.phone_display, metric='modal') }}"
                class="stat-box income-display" style="text-decoration: none;">
                <span class="stat-label">Modal</span>
                <span class="stat-value">Rp {{ "{:,.0f}".format(income).replace(',', '.') }}</span>
              </a>
              {% else %}
              <div class="stat-box income-display">
                <span class="stat-label">Modal</span>
                <span class="stat-value">Rp {{ "{:,.0f}".format(income).replace(',', '.') }}</span>
              </div>
              {% endif %}

              {% set balance = acc.display_stats.get('balance', 0) %}
              {% if acc.phone_display %}
              <a href="{{ url_for('history', phone=acc.phone_display, metric='saldo') }}"
                class="stat-box balance-display" style="text-decoration: none;">
                <span class="stat-label">Saldo</span>
                <span class="stat-value">Rp {{ "{:,.0f}".format(balance).replace(',', '.') }}</span>
              </a>
              {% else %}
              <div class="stat-box balance-display">
                <span class="stat-label">Saldo</span>
                <span class="stat-value">Rp {{ "{:,.0f}".format(balance).replace(',', '.') }}</span>
              </div>
              {% endif %}

              {% set withdrawal = acc.display_stats.get('withdrawal', 0) %}
              {% if acc.phone_display %}
              <a href="{{ url_for('history', phone=acc.phone_display, metric='pendapatan') }}"
                class="stat-box withdrawal-display" style="text-decoration: none;">
                <span class="stat-label">Pendapatan</span>
                <span class="stat-value">Rp {{ "{:,.0f}".format(withdrawal).replace(',', '.') }}</span>
              </a>
              {% else %}
              <div class="stat-box withdrawal-display">
                <span class="stat-label">Pendapatan</span>
                <span class="stat-value">Rp {{ "{:,.0f}".format(withdrawal).replace(',', '.') }}</span>
              </div>
              {% endif %}

              <button type="button" class="toggle-chart-btn" onclick="toggleChart(this)" title="Lihat Grafik">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
            </div>

            <div class="chart-wrapper" style="display: none;">
              <canvas></canvas>
              <div style="display: flex; justify-content: center; gap: 8px; margin-top: 8px;">
                <button type="button" class="chart-nav-btn prev" onclick="shiftChartDate(event, this, -1)"
                  title="Sebelumnya">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                  </svg>
                </button>
                <button type="button" class="chart-nav-btn next" onclick="shiftChartDate(event, this, 1)"
                  title="Selanjutnya" disabled>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </button>
              </div>
            </div>
            {% endif %}
          </div>
        </div>

        {%- endfor %}
        {%- else %}
        <!-- ========== BARIS DEFAULT 1 (wajib isi, required) ========== -->
        <!-- Default row if empty -->
        <div class="account-card row-item pending">
          <div class="inputs">
            {# Progress Bar + Delete Button Row (AT THE TOP) #}
            <div class="progress-delete-row">
              <div class="account-number">1</div>
              <div class="daily-progress progress-low">
                <span class="progress-label">Today:</span>
                <span class="progress-value">0/30</span>
                <span class="progress-percent">(0%)</span>
              </div>
              <button type="button" class="remove" onclick="removeRow(this)" title="Hapus akun" aria-label="Hapus akun">
                <span aria-hidden="true">‚àí</span>
              </button>
            </div>

            <div class="main-inputs">
              {# Row 1: Phone + Level #}
              <div class="input-row phone-level-row">
                <div class="phone-group">

                  <span class="phone-prefix">+62</span>
                  <input name="phone[]" type="text" placeholder="NO HP" maxlength="13" />
                </div>
                <select name="level[]" aria-label="Level">
                  <option value="E1">E1</option>
                  <option value="E2" selected>E2</option>
                  <option value="E3">E3</option>
                </select>
              </div>

              <button type="button" class="btn btn-outline-success play-btn" title="Jalankan Akun Ini (Manual)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="play-icon">
                  <polygon points="5 3 19 12 5 21 5 3" stroke="currentColor" stroke-width="2" fill="currentColor"
                    stroke-linejoin="round" />
                </svg>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="spinner-icon" style="display:none;">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" opacity="0.25" />
                  <path d="M12 2 A10 10 0 0 1 22 12" stroke="currentColor" stroke-width="2" fill="none"
                    stroke-linecap="round">
                    <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s"
                      repeatCount="indefinite" />
                  </path>
                </svg>
                <span>Run</span>
              </button>
            </div>

            {# Row 2.5: Removed redundant desktop level-run-row #}

            {# Row 3: Review + Schedule Buttons #}
            <div class="action-group">
              <button type="button" class="btn btn-warning sync-btn" title="Sync Data Saldo">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="sync-icon">
                  <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="spinner-icon" style="display:none;">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" opacity="0.25" />
                  <path d="M12 2 A10 10 0 0 1 22 12" stroke="currentColor" stroke-width="2" fill="none"
                    stroke-linecap="round">
                    <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s"
                      repeatCount="indefinite" />
                  </path>
                </svg>
                <span>Sync</span>
              </button>
              <button type="button" class="btn btn-primary review-btn" title="Set Review Harian">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M21 15v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4" stroke="currentColor" stroke-width="1.6"
                    stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M7 10l5-5 5 5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
                <span>Review</span>
              </button>
              <button type="button" class="btn btn-primary schedule-btn" title="Set Jadwal">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.6" />
                  <path d="M12 7v6l4 2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
                <span>Jadwal</span>
              </button>
            </div>

          </div>
        </div>
      </div>

      <button type="button" class="remove" onclick="removeRow(this)" title="Hapus akun" aria-label="Hapus akun">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="8" y1="12" x2="16" y2="12"></line>
        </svg>
      </button>
  </div>
  {%- endif %}
  </div>

  <!-- Tambah & Save Buttons -->
  <div style="margin-top: 16px; margin-bottom: 12px; display: flex; gap: 8px;">
    <button type="button" id="add-row" class="btn btn-outline-primary" title="Tambah Nomor" aria-label="Tambah Nomor">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    </button>
    <button type="submit" name="action" value="save" class="btn btn-outline-secondary" title="Simpan Pengaturan"
      aria-label="Simpan">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
        <polyline points="17 21 17 13 7 13 7 21"></polyline>
        <polyline points="7 3 7 8 15 8"></polyline>
      </svg>
    </button>
    <div id="save-indicator" class="save-status" style="opacity: 0;">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
        stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12" />
      </svg>
      <span>Saved</span>
    </div>
  </div>

  <!-- Bottom Controls (Simplified) -->
  <div class="bottom-card" style="display: none;">
    <div class="bottom-controls-row">

      <button type="submit" name="action" value="start" class="btn btn-success" id="run-all-btn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="play-icon">
          <polygon points="5 3 19 12 5 21 5 3" stroke="currentColor" stroke-width="1.6" fill="currentColor" />
        </svg>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="spinner-icon" style="display:none;">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" opacity="0.25" />
          <path d="M12 2 A10 10 0 0 1 22 12" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round">
            <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s"
              repeatCount="indefinite" />
          </path>
        </svg>
        <span id="btn-text">Jalankan Semua</span>
      </button>
    </div>
  </div>
  </form>

  <!-- ================= GLOBAL FINANCIAL DASHBOARD ================= -->
  <div id="global-dashboard" class="dashboard-section glass-container" style="display: none;">
    <div class="section-header">
      <h2 class="section-title-gradient">Financial Overview</h2>
      <p class="section-subtitle">Laporan Akumulasi Kekayaan Antar Akun üíé</p>
    </div>

    <div class="dashboard-grid">
      <!-- Total Modal -->
      <div class="dash-card modal-card glass-glow">
        <div class="dash-icon-wrapper">
          <div class="dash-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
              <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
              <line x1="6" y1="6" x2="6.01" y2="6"></line>
              <line x1="6" y1="18" x2="6.01" y2="18"></line>
            </svg>
          </div>
          <div class="icon-pulse"></div>
        </div>
        <div class="dash-content">
          <span class="dash-label">Total Modal</span>
          <span class="dash-value animate-value" id="total-modal">Rp 0</span>
        </div>
      </div>

      <!-- Total Saldo -->
      <div class="dash-card saldo-card glass-glow">
        <div class="dash-icon-wrapper">
          <div class="dash-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
            </svg>
          </div>
          <div class="icon-pulse"></div>
        </div>
        <div class="dash-content">
          <span class="dash-label">Total Saldo</span>
          <span class="dash-value animate-value" id="total-balance">Rp 0</span>
        </div>
      </div>

      <!-- Total Pendapatan -->
      <div class="dash-card profit-card glass-glow">
        <div class="dash-icon-wrapper">
          <div class="dash-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
          </div>
          <div class="icon-pulse"></div>
        </div>
        <div class="dash-content">
          <span class="dash-label">Total Pendapatan</span>
          <span class="dash-value animate-value" id="total-income">Rp 0</span>
        </div>
      </div>
    </div>

    <!-- Chart Section -->
    <div class="global-chart-container glass-card">
      <div class="chart-header">
        <h3>Trend Akumulasi</h3>
        <span class="live-indicator"><span class="pulse-dot"></span> Live Analytics</span>
      </div>
      <div class="global-chart-wrapper">
        <canvas id="globalChart"></canvas>
      </div>
    </div>
  </div>

  </div>


  <!-- ================= TEMPLATES ================= -->
  <!-- ================= LOG VIEWER MODAL ================= -->
  <div id="log-modal" class="log-modal">
    <div class="terminal-window">
      <div class="terminal-header">
        <div class="terminal-title">
          <span class="terminal-dot"></span>
          <span class="terminal-dot"></span>
          <span class="terminal-dot"></span>
          <span id="terminal-title-text" style="font-family: inherit; margin-left:10px;">root@mba-automation:~</span>
        </div>
        <button class="close-terminal" onclick="closeLog()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="terminal-body" id="terminal-content">
        <div class="log-line"><span class="log-timestamp">[SYSTEM]</span> Initializing console...</div>
      </div>
    </div>
  </div>

  <template id="account-card-template">
    <input name="password[]" class="pwd" type="password" placeholder="Kata Sandi" maxlength="15" required />
    <button type="button" class="pwd-toggle" aria-label="Toggle password" title="Tampilkan Password">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" class="eye-icon">
        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
        <circle cx="12" cy="12" r="3" />
      </svg>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" class="eye-off-icon" style="display:none;">
        <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" />
        <path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" />
        <path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61" />
        <line x1="2" x2="22" y1="2" y2="22" />
      </svg>
    </button>
    </div>

    <div class="more-actions-wrapper">
      <button type="button" class="btn-icon more-btn" title="Lainnya">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
          stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="1" />
          <circle cx="12" cy="5" r="1" />
          <circle cx="12" cy="19" r="1" />
        </svg>
      </button>
      <div class="more-dropdown">
        <button type="button" class="btn btn-ghost play-btn" title="Jalankan Akun">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            class="play-icon">
            <polygon points="5 3 19 12 5 21 5 3" fill="currentColor" />
          </svg>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="spinner-icon" style="display:none;">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" opacity="0.25" />
            <path d="M12 2 A10 10 0 0 1 22 12" stroke="currentColor" stroke-width="2" fill="none"
              stroke-linecap="round">
              <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s"
                repeatCount="indefinite" />
            </path>
          </svg>
          <span>Run</span>
        </button>
        <button type="button" class="btn btn-ghost sync-btn" title="Sync Saldo">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            class="sync-icon">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2" />
          </svg>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="spinner-icon" style="display:none;">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" opacity="0.25" />
            <path d="M12 2 A10 10 0 0 1 22 12" stroke="currentColor" stroke-width="2" fill="none"
              stroke-linecap="round">
              <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s"
                repeatCount="indefinite" />
            </path>
          </svg>
          <span>Sync</span>
        </button>
      </div>
    </div>
    </div>

    <div class="input-row row-2">
      <select name="level[]" aria-label="Level" class="level-select">
        <option value="E1">E1</option>
        <option value="E2" selected>E2</option>
        <option value="E3">E3</option>
      </select>

      <button type="button" class="btn btn-primary review-btn" title="Set Review Harian">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M21 15v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4" stroke="currentColor" stroke-width="1.6"
            stroke-linecap="round" stroke-linejoin="round" />
          <path d="M7 10l5-5 5 5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
        <span>Review</span>
      </button>
    </div>

    <div class="input-row row-3">
      <button type="button" class="btn btn-secondary schedule-btn" title="Set Jadwal">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.6" />
          <path d="M12 7v6l4 2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
        <span>Jadwal</span>
      </button>
      <div class="schedule-status">
        Program belum jalan otomatis, silahkan isi jadwal
      </div>
    </div>
    </div>
    </div>
    </div>
  </template>

  <!-- ================= SCRIPTS ================= -->
  <script src="{{ url_for('static', filename='js/main.js') }}?v=31"></script>
</body>

</html>