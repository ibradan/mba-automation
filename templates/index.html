<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MBA7 Automation</title>
    <style>
      :root{
        --bg:#f7f8fa;
        --card:#ffffff;
        --accent:#111827;
        --muted:#6b7280;
        --primary:#0ea5a4;
        --glass: rgba(255,255,255,0.7);
      }
      html,body{height:100%}
      body { font-family: Inter, system-ui, Arial, sans-serif; padding: 2.5rem; max-width:820px; margin: auto; background:linear-gradient(180deg,#f8fafc, #f3f6f8); color:var(--accent) }
      header{display:flex;align-items:center;justify-content:space-between;gap:20px;margin-bottom:12px}
      h1{font-weight:700;margin:0;font-size:1.25rem}
      .lead{color:var(--muted);margin:6px 0 0 0;font-size:0.95rem}
      .top-right{font-size:0.9rem;color:var(--muted)}

      .account-card{background:var(--card);border-radius:14px;padding:14px 16px;margin-bottom:12px;box-shadow:0 6px 18px rgba(16,24,40,0.06);display:flex;gap:12px;align-items:center}
      .account-card .inputs{display:flex;gap:10px;flex:1;align-items:center;flex-wrap:nowrap}
      .phone-group input[type="text"]{flex:0 0 160px}
      .pwd-field input{flex:0 0 160px}
      .account-card select{flex:0 0 84px}
      .action-group{display:inline-flex;gap:8px;align-items:center;margin-left:auto;flex-shrink:0;white-space:nowrap}
      .account-card .remove{margin-left:8px}
      .phone-prefix{display:inline-flex;align-items:center;background:#f1f5f6;border:1px solid #eef2f3;padding:8px 12px;border-radius:999px;color:var(--muted);font-weight:600}
      .phone-group{display:inline-flex;gap:8px;align-items:center}
      .account-card input[type="text"], .account-card input[type="password"], .account-card select{border:1px solid #eef2f3;padding:8px 12px;border-radius:999px;outline:none;font-size:0.92rem;background:var(--glass)}
      /* compact widths so action buttons fit on one line */
      .phone-group input[type="text"]{width:160px;max-width:40%;min-width:120px}
      .pwd-field input{width:160px;max-width:40%;min-width:120px}
      .account-card select{width:84px;min-width:64px}
      .account-card input::placeholder{color:var(--muted)}
      .account-card .remove{background:#fff;border:0;border-radius:50%;padding:8px;cursor:pointer;width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(2,6,23,0.06)}
      .account-card .remove svg{width:14px;height:14px;display:block}
      .account-card .remove:hover{transform:scale(1.04)}

      /* password field with toggle */
      .pwd-field{position:relative;display:inline-flex;align-items:center}
      .pwd-field input{padding-right:46px}
      .pwd-toggle{position:absolute;right:8px;border:0;background:transparent;color:var(--muted);cursor:pointer;padding:6px;border-radius:8px}
      .pwd-toggle svg{width:18px;height:18px}
      .pwd-toggle:hover{color:var(--primary);transform:scale(1.04)}

      #add-row{background:transparent;border:0;color:var(--primary);font-weight:700;cursor:pointer;padding:8px 0;display:inline-flex;align-items:center;gap:8px}
      #add-row svg{width:18px;height:18px}
      .actions{margin-top:14px;text-align:right}
      .actions button{background:var(--primary);color:#fff;border:0;padding:10px 18px;border-radius:12px;cursor:pointer;font-weight:700;box-shadow:0 6px 18px rgba(14,165,164,0.12)}

      /* unified button styles */
      .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer;font-size:0.92rem;min-height:36px}
      .btn svg{width:14px;height:14px}
      .btn:focus{outline:2px solid rgba(14,165,164,0.12)}
      .btn-primary{background:var(--primary);color:#fff;box-shadow:0 6px 18px rgba(14,165,164,0.12);border:0}
      .btn-primary:hover{transform:translateY(-1px);box-shadow:0 10px 26px rgba(14,165,164,0.18)}
      .btn-secondary{background:#fff;color:var(--primary);border:1px solid #d1f0ee}
      .btn-secondary:hover{transform:translateY(-1px);box-shadow:0 8px 22px rgba(14,165,164,0.06)}
      .btn-danger{background:#fff;color:#b91c1c;border:1px solid #fee2e2}
      .btn-danger:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(239,68,68,0.06)}

      /* small icon remove button */
      .remove{background:#fff;border:0;border-radius:50%;padding:8px;cursor:pointer;width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(2,6,23,0.06)}
      .remove svg{width:14px;height:14px}

      .flash{padding:0.6rem;margin-top:0.6rem;border-radius:8px}
      .flash.success{background:#ecfdf5;border:1px solid #bbf7d0}
      .flash.error{background:#fff1f2;border:1px solid #fda4af}

      @media (max-width:720px){
        .account-card{flex-direction:column;align-items:stretch}
        .account-card .inputs{flex-direction:column}
        .account-card input, .account-card select{width:100%}
        .account-card .remove{align-self:flex-end}
      }
      /* status colors */
      .account-card.ran{background: #ecfdf5; border: 1px solid #bbf7d0}
      .account-card.due{background: #fffbeb; border: 1px solid #fef3c7}
      .account-card.pending{background: #f8fafc; border: 1px solid #eef2f3}
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>MBA7 Automation</h1>
        <div class="lead">Isi akun per baris — nomor, kata sandi, dan pilih level (E1/E2/E3).</div>
      </div>
      <div class="top-right">Local UI — tidak terekspos publik</div>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash {{ category }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="post" id="automation-form">
      <div id="rows">
        {%- if saved and saved|length > 0 %}
          {%- for acc in saved %}
            <div class="account-card row-item {{ acc.status }}">
              <div class="inputs">
                <div class="phone-group">
                  <span class="phone-prefix">+62</span>
                  <input name="phone[]" type="text" placeholder="NO HP" value="{{ acc.phone_display }}" required />
                </div>
                <div class="pwd-field">
                  <input name="password[]" class="pwd" type="password" placeholder="PASSWORD" value="{{ acc.password }}" required />
                  <button type="button" class="pwd-toggle" aria-label="Toggle password">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.5 12s4-7.5 9.5-7.5S21.5 12 21.5 12s-4 7.5-9.5 7.5S2.5 12 2.5 12z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </button>
                </div>
                <select name="level[]" aria-label="Level">
                  <option value="E1" {{ 'selected' if acc.level=='E1' else '' }}>E1</option>
                  <option value="E2" {{ 'selected' if acc.level=='E2' else '' }}>E2</option>
                  <option value="E3" {{ 'selected' if acc.level=='E3' else '' }}>E3</option>
                </select>
                <div class="action-group">
                  <button type="button" class="btn btn-primary review-btn" title="Set Review Harian">Review</button>
                  <button type="button" class="btn btn-secondary schedule-btn" title="Set Jadwal">Jadwal</button>
                  <button type="button" class="btn btn-danger reset-btn" title="Reset last_run">Reset</button>
                </div>
              </div>
              <button type="button" class="remove" onclick="removeRow(this)" title="Hapus akun">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 12h12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            </div>
          {%- endfor %}
        {%- else %}
          <div class="account-card row-item">
              <div class="inputs">
              <div class="phone-group">
                <span class="phone-prefix">+62</span>
                <input name="phone[]" type="text" placeholder="NO HP" required />
              </div>
              <div class="pwd-field">
                <input name="password[]" class="pwd" type="password" placeholder="PASSWORD" required />
                <button type="button" class="pwd-toggle" aria-label="Toggle password">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.5 12s4-7.5 9.5-7.5S21.5 12 21.5 12s-4 7.5-9.5 7.5S2.5 12 2.5 12z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
              </div>
              <select name="level[]" aria-label="Level">\
                <option value="E1">E1</option>\
                <option value="E2" selected>E2</option>\
                <option value="E3">E3</option>\
              </select>\
              <div class=\"action-group\">\
                <button type=\"button\" class=\"btn btn-primary review-btn\" title=\"Set Review Harian\">Review</button>\
                <button type=\"button\" class=\"btn btn-secondary schedule-btn\" title=\"Set Jadwal\">Jadwal</button>\
                <button type=\"button\" class=\"btn btn-danger reset-btn\" title=\"Reset last_run\">Reset</button>\
              </div>\
            </div>
            <button type="button" class="remove" onclick="removeRow(this)" title="Hapus akun">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 12h12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
          </div>
          <div class="account-card row-item">
            <div class="inputs">
              <div class="phone-group">
                <span class="phone-prefix">+62</span>
                <input name="phone[]" type="text" placeholder="NO HP" />
              </div>
              <div class="pwd-field">
                <input name="password[]" class="pwd" type="password" placeholder="PASSWORD" />
                <button type="button" class="pwd-toggle" aria-label="Toggle password">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.5 12s4-7.5 9.5-7.5S21.5 12 21.5 12s-4 7.5-9.5 7.5S2.5 12 2.5 12z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
              </div>
              <select name="level[]" aria-label="Level">
                <option value="E1">E1</option>
                <option value="E2" selected>E2</option>
                <option value="E3">E3</option>
              </select>
              <button type="button" class="review-btn" title="Set Review Harian">Set Review Harian</button>
              <button type="button" class="schedule-btn" title="Set Jadwal">Set Jadwal</button>
            </div>
            <button type="button" class="remove" onclick="removeRow(this)" title="Hapus akun">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 12h12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
          </div>
        {%- endif %}
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div>
          <button type="button" id="add-row"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg> Tambah Nomor</button>
        </div>
      </div>

      <label style="display:block; margin-top:0.75rem"><input type="checkbox" name="headless" /> Jalankan headless</label>

      <div class="actions">
        <button type="submit" name="action" value="start">Mulai Automation</button>
        <button type="submit" name="action" value="save" style="margin-right:auto;background:#e5e7eb;color:#111;padding:8px 12px;border-radius:10px;font-weight:600;margin-left:8px">Simpan Akun</button>
      </div>
    </form>

    <script>
      function removeRow(btn){
        const row = btn.closest('.row-item');
        if (!row) return;
        const rows = document.querySelectorAll('.row-item');
        // keep at least one row
        if (rows.length <= 1) return;
        row.remove();
      }

      document.getElementById('add-row').addEventListener('click', function(){
        const rows = document.getElementById('rows');
        const div = document.createElement('div');
        div.className = 'account-card row-item';
        div.innerHTML = `\
          <div class="inputs">\
            <div class=\"phone-group\">\
              <span class=\"phone-prefix\">+62</span>\
              <input name=\"phone[]\" type=\"text\" placeholder=\"NO HP\" required />\
            </div>\
            <div class="pwd-field">\
              <input name="password[]" class="pwd" type="password" placeholder="PASSWORD" required />\
              <button type="button" class="pwd-toggle" aria-label="Toggle password">\
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d=\"M2.5 12s4-7.5 9.5-7.5S21.5 12 21.5 12s-4 7.5-9.5 7.5S2.5 12 2.5 12z\" stroke=\"currentColor\" stroke-width=\"1.2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/><circle cx=\"12\" cy=\"12\" r=\"3\" stroke=\"currentColor\" stroke-width=\"1.2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>\
              </button>\
            </div>\
            <select name=\"level[]\" aria-label=\"Level\">\
              <option value=\"E1\">E1</option>\
              <option value=\"E2\" selected>E2</option>\
              <option value=\"E3\">E3</option>\
            </select>\
            <button type=\"button\" class=\"review-btn\" title=\"Set Review Harian\">Set Review Harian</button>\
            <button type=\"button\" class=\"schedule-btn\" title=\"Set Jadwal\">Set Jadwal</button>\
          </div>\
          <button type=\"button\" class=\"remove\" onclick=\"removeRow(this)\" title=\"Hapus akun\">\
            <svg viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M6 12h12\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>\
          </button>`;
        rows.appendChild(div);
        attachToggle(div);
        attachReviewButtons();
        attachScheduleButtons();
        attachResetButtons();
      });
      
      // attach toggles for existing rows
      document.querySelectorAll('.row-item').forEach(function(r){ attachToggle(r); });

      // attach review button handlers
      function attachReviewButtons(){
        document.querySelectorAll('.review-btn').forEach(function(b){
          if (b.dataset.bound) return;
          b.dataset.bound = '1';
          b.addEventListener('click', function(){
            const row = b.closest('.row-item');
            if (!row) return;
            const phoneInput = row.querySelector('input[name="phone[]"]');
            if (!phoneInput) return;
            const phone = phoneInput.value.trim();
            if (!phone){ alert('Masukkan nomor HP terlebih dahulu.'); return; }
            // open review editor; phone is display (without +62)
            window.location = '/review?phone=' + encodeURIComponent(phone);
          });
        });
      }
      attachReviewButtons();

      // attach schedule button handlers
      function attachScheduleButtons(){
        document.querySelectorAll('.schedule-btn').forEach(function(b){
          if (b.dataset.bound) return;
          b.dataset.bound = '1';
          b.addEventListener('click', function(){
            const row = b.closest('.row-item');
            if (!row) return;
            const phoneInput = row.querySelector('input[name="phone[]"]');
            if (!phoneInput) return;
            const phone = phoneInput.value.trim();
            if (!phone){ alert('Masukkan nomor HP terlebih dahulu.'); return; }
            window.location = '/schedule?phone=' + encodeURIComponent(phone);
          });
        });
      }
      attachScheduleButtons();

      // attach reset last_run handlers
      function attachResetButtons(){
        document.querySelectorAll('.reset-btn').forEach(function(b){
          if (b.dataset.bound) return;
          b.dataset.bound = '1';
          b.addEventListener('click', async function(){
            const row = b.closest('.row-item');
            if (!row) return;
            const phoneInput = row.querySelector('input[name="phone[]"]');
            if (!phoneInput) return;
            const phone = phoneInput.value.trim();
            if (!phone){ alert('Masukkan nomor HP terlebih dahulu.'); return; }
            if (!confirm('Hapus catatan last_run untuk ' + phone + '?')) return;

            try{
              const form = new FormData();
              form.append('phone', phone);
              const res = await fetch('/reset_last_run', { method: 'POST', body: form });
              const data = await res.json();
              if (res.ok && data.ok){
                alert('last_run dihapus untuk ' + phone);
                window.location.reload();
              } else {
                alert('Gagal: ' + (data.msg || res.statusText));
              }
            } catch(err){
              alert('Error saat menghubungi server: ' + err);
            }
          });
        });
      }
      attachResetButtons();

      // Password reuse feature removed — each account should have its own password.

      function attachToggle(root){
        const btn = root.querySelector('.pwd-toggle');
        if (!btn) return;
        // avoid double-binding
        if (btn.dataset.bound) return;
        btn.dataset.bound = '1';
        btn.addEventListener('click', function(){
          const input = root.querySelector('.pwd');
          if (!input) return;
          if (input.type === 'password'){
            input.type = 'text';
            // change icon to closed-eye (simple swap using text)
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 3l18 18" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg>';
          } else {
            input.type = 'password';
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.5 12s4-7.5 9.5-7.5S21.5 12 21.5 12s-4 7.5-9.5 7.5S2.5 12 2.5 12z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
          }
        });
      }

      
    </script>

    <p style="margin-top:1rem; font-size:0.9rem; color:#666">Catatan: proses automation dijalankan di background. Periksa `runs.log` untuk catatan recent runs.</p>
    <div style="margin-top:0.6rem; font-size:0.9rem; color:var(--muted)">
      <strong>Level → Tugas</strong>
      <ul style="margin:0.4rem 0 0 1.1rem; padding:0; color:var(--muted)">
        <li><strong>E1</strong> = 15 tugas</li>
        <li><strong>E2</strong> = 30 tugas (default)</li>
        <li><strong>E3</strong> = 60 tugas</li>
      </ul>
      <div style="margin-top:8px; font-size:0.95rem; color:var(--muted)">
        <strong>Status warna</strong>
        <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
          <div style="display:flex;gap:8px;align-items:center">
            <span style="width:14px;height:14px;border-radius:4px;background:#ecfdf5;border:1px solid #bbf7d0;display:inline-block"></span>
            <span style="color:var(--muted)">Hijau: Sudah dijalankan (selesai)</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <span style="width:14px;height:14px;border-radius:4px;background:#fffbeb;border:1px solid #fef3c7;display:inline-block"></span>
            <span style="color:var(--muted)">Kuning: Jadwal terlewat / belum dijalankan</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <span style="width:14px;height:14px;border-radius:4px;background:#f8fafc;border:1px solid #eef2f3;display:inline-block"></span>
            <span style="color:var(--muted)">Netral: Jadwal belum tiba</span>
          </div>
        </div>
        <div style="margin-top:6px;color:var(--muted);font-size:0.88rem">Warna akan otomatis di-reset setiap pukul <strong>00:00</strong> agar status mencerminkan hari ini.</div>
      </div>
    </div>
  </body>
</html>
