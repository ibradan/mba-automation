<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dana Amal - TERNAK UANG</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=32" />
    <!-- Prefetch other pages -->
    <link rel="prefetch" href="/" as="document">
    <link rel="prefetch" href="/settings" as="document">
    <style>
        .dana-amal-container {
            margin-top: 20px;
        }

        .refresh-section {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn-refresh {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-refresh:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-refresh:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .records-table th {
            background: #f8fafc;
            padding: 14px 16px;
            text-align: left;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            font-weight: 700;
            border-bottom: 2px solid #e2e8f0;
        }

        .records-table td {
            padding: 14px 16px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.875rem;
            color: #334155;
        }

        .records-table tr:last-child td {
            border-bottom: none;
        }

        .records-table tr:hover {
            background: #f8fafc;
        }

        .amount-cell {
            font-weight: 600;
            color: #1e293b;
        }

        .profit-cell {
            font-weight: 700;
            color: #059669;
        }

        .rate-cell {
            color: #8b5cf6;
            font-weight: 600;
        }

        .period-cell {
            font-size: 0.75rem;
            color: #64748b;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .status-active {
            background: #dcfce7;
            color: #059669;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #94a3b8;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .summary-row td {
            border-top: 2px solid #059669;
        }

        .filter-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.75rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .filter-input:focus {
            border-color: #3b82f6;
        }

        .filter-row {
            background: #f8fafc;
        }

        .due-badge {
            background: #ecfdf5;
            color: #059669;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 10px;
            border-radius: 20px;
            margin-left: 10px;
            display: inline-flex;
            align-items: center;
            text-transform: uppercase;
            border: 1px solid #10b98133;
            letter-spacing: 0.5px;
        }

        .due-soon-row {
            background: #f0fdf4 !important;
        }

        .due-soon-row:hover {
            background: #def7e5 !important;
        }

        /* Quick Login - Clickable Rows */
        .clickable-row {
            cursor: pointer;
            transition: all 0.15s;
        }

        .clickable-row:hover {
            background: #f8fafc !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .clickable-row.due-soon-row:hover {
            background: #def7e5 !important;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1e293b;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            font-size: 0.875rem;
            font-weight: 600;
            z-index: 9999;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Account Filter Buttons */
        .account-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            align-items: center;
        }

        .account-selector-label {
            font-size: 0.875rem;
            font-weight: 700;
            color: #475569;
            margin-right: 8px;
        }

        .account-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
            color: #64748b;
            border-radius: 50%;
            font-size: 0.875rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .account-btn:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        .account-btn.active {
            background: #10b981;
            color: white;
            box-shadow: 0 4px 10px #10b98144;
            transform: translateY(-2px);
        }

        /* Sortable Headers */
        .sortable {
            cursor: pointer;
            position: relative;
            padding-right: 20px !important;
            user-select: none;
        }

        .sortable:hover {
            background: #f8fafc;
        }

        .sort-icon {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.3;
            transition: all 0.2s;
            font-size: 0.75rem;
        }

        .sortable.active .sort-icon {
            opacity: 1;
            color: #10b981;
        }

        .filter-chip {
            padding: 8px 16px;
            background: #f1f5f9;
            color: #64748b;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1.5px solid transparent;
            white-space: nowrap;
        }

        .filter-chip:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
        }

        .filter-chip.active {
            background: #dcfce7;
            color: #059669;
            border-color: #10b981;
            box-shadow: 0 2px 8px #10b98122;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: white;
            color: #64748b;
            padding: 10px 20px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.875rem;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }

        .back-btn:hover {
            color: #1e293b;
            border-color: #cbd5e1;
            background: #f8fafc;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .loading-state {
            text-align: center;
            padding: 60px;
            color: #64748b;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .progress-indicator {
            margin-bottom: 15px;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 8px;
            color: #0369a1;
            font-weight: 600;
        }

        .progress-indicator.success {
            background: #dcfce7;
            color: #15803d;
        }

        @media (max-width: 768px) {

            .records-table th,
            .records-table td {
                padding: 10px 8px;
                font-size: 0.75rem;
            }
        }

        /* Progress Bar Visuals */
        .period-visual {
            min-width: 140px;
        }

        .period-text {
            font-size: 0.75rem;
            font-weight: 600;
            color: #334155;
            margin-bottom: 4px;
        }

        .progress-bar-bg {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 2px;
        }

        .progress-bar-fill {
            height: 100%;
            background: #3b82f6;
            border-radius: 3px;
            width: 0%;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .days-left-text {
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        /* Mobile Card Layout Styles */
        .card-view {
            display: none;
            gap: 16px;
            flex-direction: column;
        }

        .da-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--shadow-sm);
            border: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .da-card:active {
            transform: scale(0.98);
        }

        .da-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .product-badge {
            background: #f1f5f9;
            color: #64748b;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .da-card-body {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .da-card-stats {
            display: flex;
            justify-content: space-between;
            background: #f8fafc;
            padding: 12px;
            border-radius: 12px;
            margin-top: 8px;
        }

        .da-stat {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .da-stat label {
            font-size: 0.65rem;
            color: #94a3b8;
            font-weight: 600;
            text-transform: uppercase;
        }

        .da-stat .val {
            font-size: 0.9rem;
            font-weight: 700;
            color: #334155;
        }

        .da-stat .val.profit {
            color: #059669;
        }

        .da-stat .val.rate {
            color: #8b5cf6;
        }

        .period-visual-mobile {
            width: 100%;
        }

        .progress-bar-bg.large {
            height: 10px;
            border-radius: 5px;
            background: #f1f5f9;
            margin-bottom: 6px;
        }

        .days-left-text-mobile {
            font-size: 0.8rem;
            font-weight: 700;
            color: #334155;
            text-align: right;
        }

        /* Responsive Toggles */
        @media (max-width: 768px) {
            .hidden-on-mobile {
                display: none !important;
            }

            .hidden-on-desktop {
                display: flex !important;
            }

            .records-table {
                display: none;
            }

            .card-view {
                display: flex;
            }
        }

        @media (min-width: 769px) {
            .hidden-on-desktop {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="page-header">
            <div>
                <h1 class="main-title">DANA <span>AMAL</span></h1>
                <p class="subtitle" style="color: #64748b;">Record investasi dan estimasi laba üí∞</p>
            </div>
            <a href="/" class="back-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Kembali
            </a>
        </div>

        <div class="dana-amal-container">
            <!-- Refresh & Status Section -->
            <div
                style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--shadow-sm); margin-bottom: 20px;">
                <div
                    style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 16px;">
                    <div style="flex: 1; min-width: 200px;">
                        <div style="font-size: 0.875rem; font-weight: 700; color: #475569; margin-bottom: 8px;">üìä
                            Status Data</div>
                        <div id="status-text" style="color: #64748b; font-size: 0.875rem; margin-bottom: 4px;">
                            {% if all_records %}{{ all_records|length }} records dari cache{% else %}Klik tombol untuk
                            ambil data{% endif %}
                        </div>
                        {% if all_records and all_records|length > 0 %}
                        <div style="font-size: 0.75rem; color: #94a3b8;">
                            üìÖ Update: {{ all_records[0].last_update[:16].replace('T', ' ') if
                            all_records[0].last_update else '-' }}
                        </div>
                        {% endif %}
                    </div>
                    <button type="button" class="btn-refresh" id="btn-refresh" onclick="refreshAllData()"
                        style="align-self: flex-start;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2" />
                        </svg>
                        Refresh Data
                    </button>
                </div>
            </div>

            <!-- Filter Section -->
            <div class="account-selector">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; width: 100%; flex-wrap: wrap; gap: 12px;">
                    <!-- Account Buttons -->
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <span class="account-selector-label">Filter Akun:</span>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <div class="account-btn active" onclick="setAccountFilter('all', this)" title="Semua Akun">
                                All</div>
                            {% for acc in accounts_list %}
                            <div class="account-btn" onclick="setAccountFilter('+62 {{ acc.phone_display }}', this)"
                                title="+62 {{ acc.phone_display }}">
                                {{ loop.index }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Quick Filter Chip -->
                    <div class="filter-chip" id="chip-due" onclick="toggleDueFilter(this)"
                        style="cursor: pointer; user-select: none;">
                        <span
                            style="display:inline-block; width:8px; height:8px; background:#10b981; border-radius:50%; margin-right:6px;"></span>
                        Segera Selesai
                    </div>
                </div>
            </div>

            <div class="search-filter-section" id="filter-results-info" style="display: none; padding: 10px 20px;">
                <div style="font-size: 0.75rem; color: #94a3b8;">
                    Menampilkan <span id="visible-count">0</span> dari <span id="total-count">0</span> records
                </div>
            </div>

            <div id="table-container">
                {% if all_records and all_records|length > 0 %}

                <!-- Desktop Table View -->
                <div class="table-view hidden-on-mobile">
                    <div class="table-wrapper">
                        <table class="records-table" id="dana-amal-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Akun</th>
                                    <th class="sortable" onclick="handleSort(2, 'hx')">Periode <span
                                            class="sort-icon">‚áÖ</span></th>
                                    <th>Produk</th>
                                    <th class="sortable" onclick="handleSort(4, 'number')">Invest <span
                                            class="sort-icon">‚áÖ</span></th>
                                    <th>Rate</th>
                                    <th class="sortable" onclick="handleSort(6, 'number')"> Hari <span
                                            class="sort-icon">‚áÖ</span></th>
                                    <th class="sortable" onclick="handleSort(7, 'number')">Est. Laba <span
                                            class="sort-icon">‚áÖ</span></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in all_records %}
                                <tr class="{% if item.is_due %}due-soon-row{% endif %} clickable-row"
                                    data-period="{{ item.record.period or '' }}" data-phone="{{ item.phone_display }}"
                                    onclick="quickLogin('{{ item.phone_display }}')" title="Klik untuk login ke MBA7">
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        <span class="status-badge status-active">+62 {{ item.phone_display }}</span>
                                    </td>
                                    <td>
                                        <!-- Progress Visualization Wrapper -->
                                        <div class="period-visual" data-period-raw="{{ item.record.period }}">
                                            <div class="period-text">{{ item.record.period.split('~')[1].split(' ')[0]
                                                if
                                                item.record.period and '~' in item.record.period else item.record.period
                                                }}
                                            </div>
                                            <div class="progress-bar-bg">
                                                <div class="progress-bar-fill" style="width: 0%"></div>
                                            </div>
                                            <div class="days-left-text" style="font-size: 0.7rem; color: #64748b;">
                                                Counting...
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ item.record.product or '-' }}</td>
                                    <td class="amount-cell">Rp {{ "{:,.0f}".format(item.record.amount or 0).replace(',',
                                        '.') }}</td>
                                    <td class="rate-cell">{{ item.record.rate or 0 }}%</td>
                                    <td>{{ item.record.days or 0 }}</td>
                                    <td class="profit-cell">Rp {{ "{:,.0f}".format(item.record.profit or 0).replace(',',
                                        '.') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="summary-row">
                                    <td colspan="4" style="text-align:right;">TOTAL</td>
                                    <td class="amount-cell">Rp {{ "{:,.0f}".format(total_amount).replace(',', '.') }}
                                    </td>
                                    <td colspan="2"></td>
                                    <td class="profit-cell">Rp {{ "{:,.0f}".format(total_profit).replace(',', '.') }}
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Mobile Card View -->
                <div class="card-view hidden-on-desktop" id="card-container">
                    {% for item in all_records %}
                    <div class="da-card {% if item.is_due %}da-card-due{% endif %}"
                        data-period="{{ item.record.period or '' }}" data-phone="{{ item.phone_display }}"
                        onclick="quickLogin('{{ item.phone_display }}')">

                        <div class="da-card-header">
                            <span class="status-badge status-active">+62 {{ item.phone_display }}</span>
                            <span class="product-badge">{{ item.record.product or '-' }}</span>
                        </div>

                        <div class="da-card-body">
                            <!-- Visual Progress - Duplicate logic for mobile but styled larger -->
                            <div class="period-visual-mobile" data-period-raw="{{ item.record.period }}">
                                <div class="progress-bar-bg large">
                                    <div class="progress-bar-fill" style="width: 0%"></div>
                                </div>
                                <div class="days-left-text-mobile">Calculating...</div>
                            </div>

                            <div class="da-card-stats">
                                <div class="da-stat">
                                    <label>Invest</label>
                                    <div class="val">Rp {{ "{:,.0f}".format(item.record.amount or 0).replace(',', '.')
                                        }}</div>
                                </div>
                                <div class="da-stat text-center">
                                    <label>Rate</label>
                                    <div class="val rate">{{ item.record.rate or 0 }}%</div>
                                </div>
                                <div class="da-stat text-right">
                                    <label>Est. Laba</label>
                                    <div class="val profit">Rp {{ "{:,.0f}".format(item.record.profit or 0).replace(',',
                                        '.') }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Mobile Totals -->
                    <div class="da-card summary-card">
                        <div class="da-card-stats">
                            <div class="da-stat">
                                <label>Total Invest</label>
                                <div class="val">Rp {{ "{:,.0f}".format(total_amount).replace(',', '.') }}</div>
                            </div>
                            <div class="da-stat text-right">
                                <label>Total Laba</label>
                                <div class="val profit">Rp {{ "{:,.0f}".format(total_profit).replace(',', '.') }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                {% else %}
                <div class="empty-state" id="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M9 12h6m-3-3v6M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    <p>Belum ada data dana amal. Klik tombol "Ambil Data Semua Akun" untuk scrape.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script id="accounts-json" type="application/json">{{ accounts_json|safe }}</script>
    <script>
        const accountsDataStr = document.getElementById('accounts-json').textContent;
        const accounts = JSON.parse(accountsDataStr || '[]');
        function formatRupiah(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }

        // Quick Login: Open MBA7 login page
        function quickLogin(phoneDisplay) {
            // Just open MBA7 in new tab
            window.open('https://mba7.com/#/login', '_blank');
            showToast('üåê Opening MBA7...', 2000);
        }

        function calculateProgress(periodStr) {
            try {
                // "01/16/2026 12:12:21 ~ 02/05/2026 12:13:21"
                const parts = periodStr.split('~');
                if (parts.length < 2) return { pct: 0, daysLeft: 999, label: '-' };

                const startStr = parts[0].trim();
                const endStr = parts[1].trim();

                const startDate = new Date(startStr);
                const endDate = new Date(endStr);
                const now = new Date();

                const totalMs = endDate - startDate;
                const elapsedMs = now - startDate;
                const remainingMs = endDate - now;

                let pct = (elapsedMs / totalMs) * 100;
                pct = Math.max(0, Math.min(100, pct)); // clamp 0-100

                // Days left
                const daysLeft = Math.ceil(remainingMs / (1000 * 60 * 60 * 24));

                let label = `${daysLeft} Hari Lagi`;
                let colorClass = 'normal'; // default blue/green

                if (daysLeft < 0) {
                    label = "SELESAI (Overdue)";
                    pct = 100;
                    colorClass = 'finished';
                } else if (daysLeft == 0) {
                    label = "CAIR HARI INI üí∞";
                    colorClass = 'urgent';
                } else if (daysLeft <= 2) {
                    label = `${daysLeft} Hari Lagi (Segera)`;
                    colorClass = 'warning';
                }

                return { pct, daysLeft, label, colorClass };
            } catch (e) {
                return { pct: 0, daysLeft: 999, label: 'Error', colorClass: 'normal' };
            }
        }

        // Render progress bars on load
        document.addEventListener('DOMContentLoaded', () => {
            const visuals = document.querySelectorAll('.period-visual, .period-visual-mobile');
            visuals.forEach(v => {
                const raw = v.dataset.periodRaw;
                if (!raw) return;

                const data = calculateProgress(raw);
                const fill = v.querySelector('.progress-bar-fill');

                let labelSelector = '.days-left-text';
                if (v.classList.contains('period-visual-mobile')) {
                    labelSelector = '.days-left-text-mobile';
                }
                const label = v.querySelector(labelSelector);

                // Animate width
                setTimeout(() => {
                    fill.style.width = data.pct + '%';
                }, 100);

                if (label) {
                    label.textContent = data.label;

                    // Color logic
                    if (data.colorClass === 'urgent') {
                        fill.style.background = '#eab308'; // Gold/Yellow
                        label.style.color = '#ca8a04';
                        label.style.fontWeight = '800';
                        const card = v.closest('.da-card');
                        if (card) card.style.borderColor = '#eab308';
                    } else if (data.colorClass === 'warning') {
                        fill.style.background = '#10b981'; // Green but bright
                        label.style.color = '#059669';
                        label.style.fontWeight = '700';
                        const card = v.closest('.da-card');
                        if (card) card.style.borderColor = '#10b981';
                    } else if (data.colorClass === 'finished') {
                        fill.style.background = '#3b82f6'; // Blue
                        label.textContent = "‚úÖ " + label.textContent;
                    } else {
                        fill.style.background = '#3b82f6'; // Standard Blue
                    }
                }
            });

            // Initial call to update totals/counts based on default filter (all)
            applyFilters();
        });

        // Toast notification helper
        function showToast(message, duration = 2000) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);

            // Remove after duration
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);

            return toast;
        }

        // Kept for backward compatibility if needed, but UI now handles it
        function checkDueDate(periodStr) { return { isDue: false }; }

        let activeAccount = 'all';
        let showOnlyDue = false;
        let currentSort = { index: -1, direction: 1 };



        function setAccountFilter(phone, el) {
            document.querySelectorAll('.account-btn').forEach(btn => btn.classList.remove('active'));
            el.classList.add('active');
            activeAccount = phone;
            applyFilters();
        }

        function toggleDueFilter(el) {
            showOnlyDue = !showOnlyDue;
            el.classList.toggle('active', showOnlyDue);
            applyFilters();
        }

        function handleSort(colIdx, type) {
            const table = document.getElementById("dana-amal-table");
            const headers = table.querySelectorAll('th.sortable');

            // Update direction
            if (currentSort.index === colIdx) {
                currentSort.direction *= -1;
            } else {
                currentSort.index = colIdx;
                currentSort.direction = -1; // Default to desc (high to low)
            }

            // Update header UI
            headers.forEach(h => h.classList.remove('active'));
            const activeHeader = Array.from(headers).find(h => h.onclick.toString().includes(colIdx));
            if (activeHeader) {
                activeHeader.classList.add('active');
                activeHeader.querySelector('.sort-icon').textContent = currentSort.direction === 1 ? '‚Üë' : '‚Üì';
            }

            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                let vA, vB;

                if (type === 'number') {
                    vA = parseInt(a.cells[colIdx].textContent.replace(/[^\d]/g, '')) || 0;
                    vB = parseInt(b.cells[colIdx].textContent.replace(/[^\d]/g, '')) || 0;
                } else if (type === 'hx') {
                    // Sort by days remaining until end date
                    const periodA = a.getAttribute('data-period') || '';
                    const periodB = b.getAttribute('data-period') || '';

                    // Always calculate days remaining for proper sorting (not just due items)
                    vA = parseHxDays(periodA);
                    vB = parseHxDays(periodB);
                } else {
                    vA = a.cells[colIdx].textContent.toLowerCase();
                    vB = b.cells[colIdx].textContent.toLowerCase();
                }

                if (vA < vB) return -1 * currentSort.direction;
                if (vA > vB) return 1 * currentSort.direction;
                return 0;
            });

            rows.forEach(row => tbody.appendChild(row));
            updateRowNumbers();
        }

        function parseHxDays(periodStr) {
            try {
                const endPart = periodStr.split('~')[1].trim().split(' ')[0];
                const [m, d, y] = endPart.split('/');
                const endDate = new Date(y, m - 1, d);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return Math.ceil((endDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
            } catch (e) { return 999; }
        }

        function updateRowNumbers() {
            const table = document.getElementById("dana-amal-table");
            const rows = Array.from(table.querySelectorAll('tbody tr')).filter(r => r.style.display !== 'none');
            rows.forEach((row, idx) => {
                row.cells[0].textContent = idx + 1;
            });
        }

        function applyFilters() {
            // Apply to table rows
            const table = document.getElementById("dana-amal-table");
            let tableRows = [];
            if (table) {
                tableRows = Array.from(table.getElementsByTagName("tbody")[0].getElementsByTagName("tr"));
            }

            // Apply to cards
            const cardContainer = document.getElementById('card-container');
            let cards = [];
            if (cardContainer) {
                cards = Array.from(cardContainer.querySelectorAll('.da-card:not(.summary-card)'));
            }

            const resultsInfo = document.getElementById("filter-results-info");
            const visibleEl = document.getElementById("visible-count");
            const totalEl = document.getElementById("total-count");

            let visibleCount = 0;
            let visibleAmount = 0;
            let visibleProfit = 0;

            // Function to check filter for an element (row or card)
            const checkFilter = (el, type) => {
                const phoneData = el.getAttribute('data-phone') || '';
                const isDue = el.classList.contains(type === 'table' ? 'due-soon-row' : 'da-card-due');

                // Account Filter
                // Note: phoneData is like "812XXXX", activeAccount can be "all" or specific
                const matchAccount = activeAccount === 'all' || phoneData.includes(activeAccount) || ("+62 " + phoneData).includes(activeAccount);
                const matchDue = !showOnlyDue || isDue;

                return matchAccount && matchDue;
            };

            // Apply to table rows
            tableRows.forEach(row => {
                const show = checkFilter(row, 'table');
                row.style.display = show ? "" : "none";
                if (show) {
                    visibleCount++;
                    const amountCell = row.querySelector('.amount-cell');
                    const profitCell = row.querySelector('.profit-cell');
                    if (amountCell) {
                        const val = amountCell.textContent.replace(/[^\d]/g, '');
                        visibleAmount += parseInt(val || 0);
                    }
                    if (profitCell) {
                        const val = profitCell.textContent.replace(/[^\d]/g, '');
                        visibleProfit += parseInt(val || 0);
                    }
                }
            });

            // Apply to cards (independent logic for visibility, but totals share same data source so we track visibleCount from table rows primarily if available, else counting cards would be double counting if we did both. 
            // Since table rows are primary source of truth for totals, we rely on them. But if mobile only, we might rely on cards. 
            // Safe bet: calculate totals from whatever is processed. If both exist, we might double count if we aren't careful.
            // Wait, usually both exist in DOM but one is hidden via CSS. 
            // So we should only sum up ONCE. We summed up tableRows above.

            cards.forEach(card => {
                const show = checkFilter(card, 'card');
                card.style.display = show ? "" : "none";
            });

            // Update row numbers for visible table rows
            updateRowNumbers();

            // Update totals in footer (table only has footer)
            const totalAmountCell = document.querySelector('.summary-row .amount-cell');
            const totalProfitCell = document.querySelector('.summary-row .profit-cell');
            if (totalAmountCell) totalAmountCell.textContent = 'Rp ' + formatRupiah(visibleAmount);
            if (totalProfitCell) totalProfitCell.textContent = 'Rp ' + formatRupiah(Math.round(visibleProfit));

            // Update totals in mobile summary card
            const mobileSumCard = document.querySelector('.summary-card');
            if (mobileSumCard) {
                const amountVal = mobileSumCard.querySelector('.da-stat:first-child .val');
                const profitVal = mobileSumCard.querySelector('.da-stat:last-child .val');
                if (amountVal) amountVal.textContent = 'Rp ' + formatRupiah(visibleAmount);
                if (profitVal) profitVal.textContent = 'Rp ' + formatRupiah(Math.round(visibleProfit));
                mobileSumCard.style.display = (visibleCount > 0) ? "block" : "none";
            }

            // Update results info
            if (activeAccount !== 'all' || showOnlyDue) {
                resultsInfo.style.display = "block";
                visibleEl.textContent = visibleCount;
                // Total is total unique items, which effectively is tableRows.length
                totalEl.textContent = tableRows.length || cards.length;
            } else {
                resultsInfo.style.display = "none";
            }
        }

        async function refreshAllData() {
            const btn = document.getElementById('btn-refresh');
            const container = document.getElementById('table-container');
            const statusText = document.getElementById('status-text');

            if (accounts.length === 0) {
                alert('Tidak ada akun tersedia.');
                return;
            }

            btn.disabled = true;

            // Create status log container
            let logHtml = `<div style="max-height: 150px; overflow-y: auto; background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.8rem; border: 1px solid #e2e8f0;">`;

            // Create hybrid structure (Table + Cards)
            container.innerHTML = `
                <div class="progress-indicator" id="progress-indicator">
                    <span class="spinner" style="width:14px;height:14px;border-width:2px;display:inline-block;margin-right:8px;vertical-align:middle;"></span>
                    Memulai...
                </div>
                <div id="status-log-container">${logHtml}</div>
                
                <!-- Table View -->
                <div class="table-view hidden-on-mobile">
                    <div class="table-wrapper">
                        <table class="records-table" id="dana-amal-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Akun</th>
                                    <th class="sortable" onclick="handleSort(2, 'hx')">Periode <span class="sort-icon">‚áÖ</span></th>
                                    <th>Produk</th>
                                    <th class="sortable" onclick="handleSort(4, 'number')">Invest <span class="sort-icon">‚áÖ</span></th>
                                    <th>Rate</th>
                                    <th class="sortable" onclick="handleSort(6, 'number')"> Hari <span class="sort-icon">‚áÖ</span></th>
                                    <th class="sortable" onclick="handleSort(7, 'number')">Est. Laba <span class="sort-icon">‚áÖ</span></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot>
                                <tr class="summary-row">
                                    <td colspan="4" style="text-align:right;">TOTAL</td>
                                    <td class="total-amount-cell">Rp 0</td>
                                    <td colspan="2"></td>
                                    <td class="total-profit-cell">Rp 0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Card View -->
                <div class="card-view hidden-on-desktop" id="card-container">
                    <!-- Cards will be appended here -->
                    <div class="da-card summary-card" style="display:none; order: 9999;">
                        <div class="da-card-stats">
                             <div class="da-stat">
                                <label>Total Invest</label>
                                <div class="val total-amount-card">Rp 0</div>
                            </div>
                             <div class="da-stat text-right">
                                <label>Total Laba</label>
                                <div class="val profit total-profit-card">Rp 0</div>
                            </div>
                        </div>
                     </div>
                </div>
            `;

            const progressEl = document.getElementById('progress-indicator');
            const logContainer = document.querySelector('#status-log-container > div');

            // Containers for appending
            const tbody = document.querySelector('#dana-amal-table tbody');
            const cardContainer = document.getElementById('card-container');
            const summaryCard = cardContainer.querySelector('.summary-card');

            let grandTotalAmount = 0;
            let grandTotalProfit = 0;
            let rowCount = 0;

            // Process accounts one by one
            for (let i = 0; i < accounts.length; i++) {
                const phone = accounts[i].phone_display;
                progressEl.innerHTML = `<span class="spinner" style="width:14px;height:14px;border-width:2px;display:inline-block;margin-right:8px;vertical-align:middle;"></span> Memproses akun ${i + 1}/${accounts.length}: +62 ${phone}...`;

                try {
                    const res = await fetch(`/api/dana_amal/${phone}`);

                    // Handle non-OK responses or non-JSON content
                    if (!res.ok) {
                        const errorText = await res.text();
                        let errorMsg = `Server Error (${res.status})`;
                        if (res.status === 504 || res.status === 502) errorMsg = "Server Timeout (Website Berat)";
                        throw new Error(errorMsg);
                    }

                    const contentType = res.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) {
                        throw new Error("Server Error (Bukan JSON - Kemungkinan Timeout)");
                    }

                    const data = await res.json();

                    if (data.records && data.records.length > 0) {

                        data.records.forEach(r => {
                            rowCount++;
                            grandTotalAmount += r.amount || 0;
                            grandTotalProfit += r.profit || 0;

                            const dueInfo = calculateProgress(r.period || "");

                            // ---- 1. Append to Table ----
                            const tr = document.createElement('tr');
                            tr.className = 'clickable-row';
                            tr.setAttribute('data-period', r.period || '');
                            tr.setAttribute('data-phone', phone);
                            tr.onclick = () => quickLogin(phone);
                            if (dueInfo.daysLeft <= 0) tr.classList.add('due-soon-row'); // Simple check reusing logic

                            tr.innerHTML = `
                                <td>${rowCount}</td>
                                <td>
                                    <span class="status-badge status-active">+62 ${phone}</span>
                                    <div style="font-size: 0.65rem; color: #94a3b8; margin-top: 2px;">Update: ${new Date().toLocaleString('id-ID')}</div>
                                </td>
                                <td>
                                    <!-- Progress Visualization -->
                                    <div class="period-visual" data-period-raw="${r.period || ''}">
                                        <div class="period-text">${(r.period && r.period.includes('~')) ? r.period.split('~')[1].split(' ')[0] : (r.period || '-')}</div>
                                        <div class="progress-bar-bg">
                                            <div class="progress-bar-fill" style="width: ${dueInfo.pct}%; background: ${dueInfo.colorClass === 'urgent' ? '#eab308' : (dueInfo.colorClass === 'warning' ? '#10b981' : '#3b82f6')}"></div>
                                        </div>
                                        <div class="days-left-text" style="font-size: 0.7rem; color: #64748b;">${dueInfo.label}</div>
                                    </div>
                                </td>
                                <td>${r.product || '-'}</td>
                                <td class="amount-cell">Rp ${formatRupiah(r.amount || 0)}</td>
                                <td class="rate-cell">${r.rate || 0}%</td>
                                <td>${r.days || 0}</td>
                                <td class="profit-cell">Rp ${formatRupiah(Math.round(r.profit || 0))}</td>
                            `;
                            tbody.appendChild(tr);

                            // ---- 2. Append to Card View ----
                            const card = document.createElement('div');
                            card.className = `da-card ${dueInfo.daysLeft <= 0 ? 'da-card-due' : ''}`;
                            card.setAttribute('data-period', r.period || '');
                            card.setAttribute('data-phone', phone);
                            card.onclick = () => quickLogin(phone);
                            if (dueInfo.colorClass === 'urgent') card.style.borderColor = '#eab308';
                            if (dueInfo.colorClass === 'warning') card.style.borderColor = '#10b981';

                            card.innerHTML = `
                                <div class="da-card-header">
                                    <span class="status-badge status-active">+62 ${phone}</span>
                                    <span class="product-badge">${r.product || '-'}</span>
                                </div>
                                <div class="da-card-body">
                                    <div class="period-visual-mobile" data-period-raw="${r.period || ''}">
                                        <div class="progress-bar-bg large">
                                            <div class="progress-bar-fill" style="width: ${dueInfo.pct}%; background: ${dueInfo.colorClass === 'urgent' ? '#eab308' : (dueInfo.colorClass === 'warning' ? '#10b981' : '#3b82f6')}"></div>
                                        </div>
                                        <div class="days-left-text-mobile" style="${dueInfo.colorClass === 'urgent' ? 'color:#ca8a04' : (dueInfo.colorClass === 'warning' ? 'color:#059669' : '')}">${dueInfo.label}</div>
                                    </div>
                                    <div class="da-card-stats">
                                        <div class="da-stat">
                                            <label>Invest</label>
                                            <div class="val">Rp ${formatRupiah(r.amount || 0)}</div>
                                        </div>
                                        <div class="da-stat text-center">
                                            <label>Rate</label>
                                            <div class="val rate">${r.rate || 0}%</div>
                                        </div>
                                        <div class="da-stat text-right">
                                            <label>Est. Laba</label>
                                            <div class="val profit">Rp ${formatRupiah(Math.round(r.profit || 0))}</div>
                                        </div>
                                    </div>
                                </div>
                             `;
                            // Insert before summary card
                            cardContainer.insertBefore(card, summaryCard);
                        });

                        // Update totals
                        const totalAmStr = 'Rp ' + formatRupiah(grandTotalAmount);
                        const totalPrStr = 'Rp ' + formatRupiah(Math.round(grandTotalProfit));

                        document.querySelector('.total-amount-cell').textContent = totalAmStr;
                        document.querySelector('.total-profit-cell').textContent = totalPrStr;
                        document.querySelector('.total-amount-card').textContent = totalAmStr;
                        document.querySelector('.total-profit-card').textContent = totalPrStr;
                        summaryCard.style.display = 'block';

                        // Log success with timestamp
                        const timeStr = new Date().toLocaleTimeString('id-ID');
                        logContainer.innerHTML += `<div style="color: green;">‚úì [${timeStr}] +62 ${phone}: Ditemukan ${data.records.length} records</div>`;
                    } else {
                        // Log empty or error msg
                        const timeStr = new Date().toLocaleTimeString('id-ID');
                        const msg = data.status_msg || 'Tidak ada data investasi';
                        logContainer.innerHTML += `<div style="color: #64748b;">‚Ä¢ [${timeStr}] +62 ${phone}: ${msg}</div>`;
                    }
                } catch (e) {
                    console.error(`Error fetching for ${phone}:`, e);
                    // Log error
                    const timeStr = new Date().toLocaleTimeString('id-ID');
                    logContainer.innerHTML += `<div style="color: red;">‚úó [${timeStr}] +62 ${phone}: Gagal (${e.message || 'Error'})</div>`;
                }

                // Auto scroll log
                logContainer.scrollTop = logContainer.scrollHeight;

                // Add 1s delay to prevent resource spike on Pi
                if (i < accounts.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            progressEl.className = 'progress-indicator success';
            progressEl.innerHTML = `‚úì SELESAI: Berhasil memproses ${accounts.length} akun.`;
            btn.disabled = false;
        }

        // Apply highlights to initial data on load
        document.addEventListener('DOMContentLoaded', () => {
            const table = document.getElementById('dana-amal-table');
            if (!table) return;

            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const period = row.getAttribute('data-period');
                if (period) {
                    const dueInfo = checkDueDate(period);
                    if (dueInfo.isDue) {
                        row.classList.add('due-soon-row');
                        const periodCell = row.querySelector('.period-cell');
                        if (periodCell) {
                            let badge = periodCell.querySelector('.due-badge');
                            if (!badge) {
                                badge = document.createElement('span');
                                badge.className = 'due-badge';
                                periodCell.appendChild(badge);
                            }
                            badge.innerText = dueInfo.label;
                        }
                    }
                }
            });
        });
    </script>
</body>

</html>
<!-- ================= BOTTOM NAVIGATION ================= -->
<nav class="bottom-nav">
    <a href="/" class="bottom-nav-item">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
            <polyline points="9 22 9 12 15 12 15 22" />
        </svg>
        <span>Tugas & Absen</span>
    </a>
    <a href="/dana_amal" class="bottom-nav-item active">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
        <span>Dana Amal</span>
    </a>
    <a href="/settings" class="bottom-nav-item">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
            </path>
        </svg>
        <span>Settings</span>
    </a>
</nav>
<!-- Loading indicator -->
<div id="page-loading" class="page-loading" style="display: none;"></div>

<script>
    document.querySelectorAll('.bottom-nav-item').forEach(item => {
        item.addEventListener('click', function (e) {
            if (this.classList.contains('active')) {
                e.preventDefault();
                return;
            }
            document.getElementById('page-loading').style.display = 'block';
            this.classList.add('loading');
        });
    });
</script>
</body>

</html>